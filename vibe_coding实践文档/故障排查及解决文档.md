# DreamAIChat 故障排查及解决文档

本文档记录项目开发过程中遇到的各种错误、异常及其解决方案，方便后续参考和快速定位问题。

---

## 目录

- [后端启动错误](#后端启动错误)
  - [JWT 密钥长度不足错误](#jwt-密钥长度不足错误)
- [Gradle 构建问题](#gradle-构建问题)
- [Android 客户端问题](#android-客户端问题)

---

## 后端启动错误

### JWT 密钥长度不足错误

**错误信息**：
```
Caused by: io.jsonwebtoken.security.WeakKeyException: The specified key byte array is 200 bits which is not secure enough for any JWT HMAC-SHA algorithm. The JWT JWA Specification (RFC 7518, Section 3.2) states that keys used with HMAC-SHA algorithms MUST have a size >= 256 bits (the key size must be greater than or equal to the hash output size).
```

**错误原因**：
- JWT 库要求 HMAC-SHA 算法的密钥必须至少 256 位（32 字节）
- 如果 `application.yml` 中的 `security.jwt.secret` 配置的密钥长度不足 32 个字符，或者通过环境变量 `DREAMAI_JWT_SECRET` 设置的密钥太短，就会触发此错误

**解决方案**：

#### 方案一：使用足够长的密钥（推荐）

在 `DreamAIChat_backend/src/main/resources/application.yml` 中确保默认密钥至少 32 个字符：

```yaml
security:
  jwt:
    secret: ${DREAMAI_JWT_SECRET:DreamAIChatSuperSecretKeyForJWT2024Secure}
    expire-hours: 168
```

或者通过环境变量设置（在 IDEA 运行配置中）：
- 环境变量名：`DREAMAI_JWT_SECRET`
- 环境变量值：至少 32 个字符的字符串，例如：`DreamAIChatSuperSecretKeyForJWT2024Secure1234567890`

#### 方案二：代码自动处理（已实现）

代码中已经实现了自动密钥扩展逻辑（`JwtService.kt`）：
- 如果密钥长度 < 32 字节：使用 SHA-256 哈希自动扩展到 32 字节
- 如果密钥长度 > 32 字节：截取前 32 字节
- 如果密钥长度 = 32 字节：直接使用

**验证修复**：
1. 确保 `JwtService.kt` 中包含密钥扩展逻辑（第 22-33 行）
2. 清理构建缓存：`.\gradlew.bat clean build`
3. 在 IDEA 中清理缓存：`File` → `Invalidate Caches...` → `Invalidate and Restart`
4. 重新运行后端应用

**相关文件**：
- `DreamAIChat_backend/src/main/kotlin/com/dreamaichat/backend/service/JwtService.kt`
- `DreamAIChat_backend/src/main/resources/application.yml`

**发生时间**：2025-11-28

---

## Gradle 构建问题

### Gradle Wrapper 文件缺失

**错误信息**：
```
Error: Unable to access jarfile gradle/wrapper/gradle-wrapper.jar
或
Could not find or load main class org.gradle.wrapper.GradleWrapperMain
```

**解决方案**：
在项目根目录执行：
```powershell
.\gradlew.bat wrapper --gradle-version 8.13
```

**相关文件**：
- `gradle/wrapper/gradle-wrapper.jar`
- `gradle/wrapper/gradle-wrapper.properties`

---

### Gradle 同步缓慢

**问题描述**：
Gradle 同步或构建时下载依赖速度很慢。

**解决方案**：
1. 配置国内镜像源（已在 `settings.gradle.kts` 中配置腾讯云镜像）
2. 启用 Gradle Daemon：在 `gradle.properties` 中添加 `org.gradle.daemon=true`
3. 启用并行构建：`org.gradle.parallel=true`
4. 启用配置缓存：`org.gradle.configuration-cache=true`

**相关文件**：
- `DreamAIChat_backend/settings.gradle.kts`

---

## Android 客户端问题

### XML 布局文件 BOM 字符错误

**错误信息**：
```
line 1:0 mismatched input '﻿' expecting {COMMENT, SEA_WS, '<', PI}
Cannot read field "elmName" because "root" is null
```

**错误原因**：
- XML 布局文件以 UTF-8 with BOM（Byte Order Mark）编码保存
- BOM 字符（`U+FEFF`，显示为 `﻿`）导致 XML 解析器无法正确解析文件
- 常见于使用某些编辑器（如 Windows 记事本）保存文件时

**解决方案**：

#### 方案一：批量移除 BOM（推荐，快速）

使用 PowerShell 命令批量移除所有 XML 文件的 BOM：

```powershell
cd D:\ProgramFiles\CodeProjects\Android\projects\DreamAIChat\DreamAIChat_APP
Get-ChildItem app\src\main\res\layout\*.xml | ForEach-Object {
    $bytes = [System.IO.File]::ReadAllBytes($_.FullName)
    if ($bytes.Length -ge 3 -and $bytes[0] -eq 0xEF -and $bytes[1] -eq 0xBB -and $bytes[2] -eq 0xBF) {
        Write-Host "Removing BOM from: $($_.Name)"
        $newBytes = $bytes[3..($bytes.Length-1)]
        [System.IO.File]::WriteAllBytes($_.FullName, $newBytes)
    }
}
```

这个命令会：
1. 遍历 `app/src/main/res/layout/` 目录下的所有 XML 文件
2. 检查文件开头是否有 BOM（字节序列 `EF BB BF`）
3. 如果有，移除前 3 个字节并重新保存文件

#### 方案二：在 Android Studio 中手动修复

1. **打开有问题的 XML 文件**
2. **检查编码**：
   - 选择 `File` → `File Encoding`
   - 如果显示 `UTF-8 with BOM`，选择 `Remove BOM` 或切换到 `UTF-8`
3. **保存文件**（Ctrl+S）

#### 方案三：重新创建文件

如果方案一和方案二都无效：
1. 复制文件内容
2. 删除原文件
3. 创建新文件并粘贴内容
4. 确保保存为 UTF-8（无 BOM）编码

**验证修复**：
1. 清理构建：`.\gradlew.bat clean`
2. 重新构建：`.\gradlew.bat :app:assembleDebug`
3. 如果不再出现 BOM 错误，说明修复成功

**相关文件**：
- `app/src/main/res/layout/activity_main.xml`
- `app/src/main/res/layout/item_message_user.xml`
- `app/src/main/res/layout/fragment_history.xml`
- `app/src/main/res/layout/item_conversation.xml`
- `app/src/main/res/layout/item_message_ai.xml`
- `app/src/main/res/layout/item_message_system.xml`
- 以及其他所有 XML 布局文件

**预防措施**：
- 在 Android Studio 中设置默认编码为 UTF-8（无 BOM）
  - `File` → `Settings` → `Editor` → `File Encodings`
  - 将 `Default encoding for properties files` 设置为 `UTF-8`
  - 取消勾选 `Create UTF-8 files with BOM`
- 避免使用 Windows 记事本编辑 XML 文件
- 使用 Android Studio 或 VS Code 等专业编辑器

---

### 后端连接失败

**错误信息**：
```
java.net.ConnectException: Failed to connect to /10.0.2.2:8081
```

**解决方案**：
1. **Android 模拟器**：使用 `10.0.2.2` 访问宿主机 `localhost`
2. **物理设备**：将 `10.0.2.2` 替换为你的电脑 IP 地址（例如：`192.168.1.100`）
3. 确保后端服务已启动并运行在 8081 端口
4. 检查防火墙设置，确保 8081 端口未被阻止

**相关文件**：
- `app/src/main/java/com/example/dreamaichat_app/data/remote/RetrofitClient.java`

---

## 注意事项

1. **文件路径问题**：如果使用 Git worktree，注意实际文件路径可能与工作区路径不同
2. **缓存问题**：修改代码后如果问题仍然存在，尝试清理构建缓存和 IDEA 缓存
3. **环境变量优先级**：环境变量会覆盖 `application.yml` 中的配置
4. **XML 文件编码**：所有 XML 文件必须使用 UTF-8（无 BOM）编码

---

---

## API 调用超时问题

### 问题描述

当向 AI 模型发送复杂问题时（如"请讲解字节跳动公司"），APP 返回请求超时错误。

**错误表现**：
- Android 客户端：请求发送后长时间无响应，最终超时
- 后端日志：可能显示正常处理，但客户端已超时

**错误原因**：
- Android 客户端的 `readTimeout` 设置为 30 秒，对于复杂问题可能不够
- 后端调用 AI 模型的超时设置为 60 秒，但复杂回答可能需要更长时间

**解决方案**：

#### 1. 增加 Android 客户端超时时间

修改 `app/src/main/java/com/example/dreamaichat_app/data/remote/RetrofitClient.java`：

```java
OkHttpClient okHttpClient = new OkHttpClient.Builder()
    .addInterceptor(loggingInterceptor)
    .connectTimeout(15, TimeUnit.SECONDS)
    .readTimeout(120, TimeUnit.SECONDS)  // 从 30 秒增加到 120 秒
    .writeTimeout(30, TimeUnit.SECONDS)
    .build();
```

#### 2. 增加后端模型调用超时时间

修改 `DreamAIChat_backend/src/main/kotlin/com/dreamaichat/backend/service/ModelRouterService.kt`：

```kotlin
.timeout(Duration.ofSeconds(120))  // 从 60 秒增加到 120 秒
```

**验证修复**：
1. 重新编译并运行 Android 应用
2. 重启后端服务
3. 发送复杂问题测试，应该能正常收到回复

**相关文件**：
- `app/src/main/java/com/example/dreamaichat_app/data/remote/RetrofitClient.java`
- `DreamAIChat_backend/src/main/kotlin/com/dreamaichat/backend/service/ModelRouterService.kt`

**发生时间**：2025-11-30

---

## API Key 配置问题

### 问题描述

后端返回演示模式回复，提示"当前模型未配置真实 API Key"。

**错误表现**：
- 后端日志显示：`API Key 前10个字符: DEMO-KEY...`
- APP 收到演示模式的回复，而不是真实的 AI 回复

**错误原因**：
1. 环境变量未正确设置
2. IDEA 启动时未使用 `local` profile，导致未读取 `application-local.yml`
3. 环境变量设置后未重启后端服务

**解决方案**：

#### 方案一：使用系统环境变量（推荐）

**步骤 1：设置环境变量**

1. 按 `Win + R`，输入 `sysdm.cpl`，回车
2. 点击 **"高级"** → **"环境变量"**
3. 在 **"用户变量"** 区域点击 **"新建"**：
   - 变量名：`DEEPSEEK_API_KEY`
   - 变量值：你的 DeepSeek API Key（格式：`sk-xxxxx`）
   - 变量名：`DOUBAO_API_KEY`
   - 变量值：你的豆包 API Key
4. 点击 **"确定"** 保存

**步骤 2：在 IDEA 中配置环境变量**

1. 在 IDEA 中打开运行配置：**"Run"** → **"Edit Configurations..."**
2. 找到 **"DreamAiChatBackendApplication"** 配置
3. 在 **"Environment variables"** 中添加：
   ```
   DEEPSEEK_API_KEY=sk-你的密钥
   DOUBAO_API_KEY=你的豆包密钥
   ```
4. 点击 **"Apply"** → **"OK"** 保存

**步骤 3：重启后端服务**

1. 停止当前运行的后端（如果正在运行）
2. 在 IDEA 中重新启动后端
3. 查看控制台输出，确认 API Key 已正确读取

#### 方案二：使用 application-local.yml

**步骤 1：编辑本地配置文件**

1. 打开 `DreamAIChat_backend/src/main/resources/application-local.yml`
2. 填入你的 API Key：
   ```yaml
   chat:
     providers:
       deepseek:
         api-key: sk-你的DeepSeek密钥
       doubao:
         api-key: 你的豆包密钥
         model: doubao-seed-1-6-vision-250815
   ```
3. 保存文件

**步骤 2：在 IDEA 中配置 Active profiles**

1. 在 IDEA 中打开运行配置：**"Run"** → **"Edit Configurations..."**
2. 找到 **"DreamAiChatBackendApplication"** 配置
3. 在 **"Active profiles"** 中输入：`local`
4. 点击 **"Apply"** → **"OK"** 保存

**步骤 3：重启后端服务**

1. 停止当前运行的后端
2. 在 IDEA 中重新启动后端
3. 查看控制台输出，应该看到：`The following profiles are active: local`

**验证修复**：
1. 在 Android 应用中切换到对应模型
2. 发送测试消息（例如："你好"）
3. 如果收到真实的 AI 回复（不是演示模式），说明配置成功 ✅

**相关文件**：
- `DreamAIChat_backend/src/main/resources/application.yml`
- `DreamAIChat_backend/src/main/resources/application-local.yml`
- `.gitignore`（确保 `application-local.yml` 不会被提交）

**预防措施**：
- 永远不要将 API Key 直接写在 `application.yml` 中并提交到 Git
- 使用环境变量或 `application-local.yml`（已在 `.gitignore` 中排除）
- 定期轮换 API Key

**发生时间**：2025-11-30

---

## 历史会话仅显示最后一轮对话

### 问题描述

在与大模型进行了多轮对话后，返回历史列表再次进入会话，界面只显示“最后一次”用户与 AI 的来回，其余内容全部丢失。

**错误表现**：
- 历史会话界面只看到最新的两条消息
- Logcat 中无报错，但本地提示“本地保存聊天记录失败：FOREIGN KEY constraint failed”

### 错误原因

Room 中的 `messages` 表配置了指向 `conversations` 的外键。我们在 `ConversationDao` 上使用了 `OnConflictStrategy.REPLACE`，每次更新会话信息时会删除旧行并重新插入，级联删除会把之前的所有消息都清空，最终只剩下最近一次插入的两条消息。

### 解决方案

1. 将 `ConversationDao.insertConversation` 的策略改为 `OnConflictStrategy.IGNORE`，避免删除旧记录
2. 新增 `updateConversationMeta`，在需要更新标题/模型/最后消息时执行 `UPDATE` 而不是 `REPLACE`
3. `ConversationRepository.insertOrUpdateConversation` 先 `insert`（忽略重复）再调用 `updateConversationMeta`
4. `ChatViewModel` 的 `persistConversationAndMessages` 每次成功发送后同时写入 `ConversationEntity` 和两条 `MessageEntity`

**相关文件**：
- `app/src/main/java/com/example/dreamaichat_app/data/dao/ConversationDao.java`
- `app/src/main/java/com/example/dreamaichat_app/data/repository/ConversationRepository.java`
- `app/src/main/java/com/example/dreamaichat_app/ui/chat/ChatViewModel.java`

**发生时间**：2025-12-01

---

## 对话时间显示不准确 / 聊天气泡重复展示时间

### 问题描述

1. 聊天界面中，每条气泡下方都会重复显示发送时间，信息拥挤
2. 历史会话列表的时间存在 8 小时偏差，展示的时间与用户所在时区不一致

### 解决方案

1. 移除聊天气泡中的时间 TextView，仅保留消息内容与状态（`item_message_ai.xml`、`item_message_user.xml`、`ChatMessageAdapter.java`）
2. 历史会话列表统一使用 `Asia/Shanghai` 时区格式化时间，保证“第一次对话时间”显示正确（`ConversationAdapter.java`）

**相关文件**：
- `app/src/main/res/layout/item_message_ai.xml`
- `app/src/main/res/layout/item_message_user.xml`
- `app/src/main/java/com/example/dreamaichat_app/ui/chat/adapter/ChatMessageAdapter.java`
- `app/src/main/java/com/example/dreamaichat_app/ui/history/adapter/ConversationAdapter.java`

**发生时间**：2025-12-01

---

## 历史页“开始对话”按钮无响应

### 问题描述

首次注册或登录后进入历史页可能看到“还没有对话”的空态提示，点击“开始对话”按钮却不会跳回聊天页，导致无法发起第一轮对话。

### 错误原因

空态按钮仅调用 `FragmentManager.popBackStack()`，但历史页是通过底部导航切换的 Fragment，并未加入返回栈。结果既不会切换 Fragment，也没有真正创建新的会话。

### 解决方案

1. 在 `HistoryFragment` 中使用 `MainActivity` 实例获取共享的 `ChatViewModel`
2. 点击按钮时执行：
   - `chatViewModel.startNewChat()` 创建新会话
   - `mainActivity.showChatFragment()` 主动切换到聊天页

**相关文件**：
- `app/src/main/java/com/example/dreamaichat_app/ui/history/HistoryFragment.java`
- `app/src/main/java/com/example/dreamaichat_app/ui/main/MainActivity.java`

**发生时间**：2025-12-02

---

## 聊天页快捷 Chip / 图片预览遮挡模型切换

### 问题描述

“总结内容”“润色文案”等快捷 Chip，以及多图预览缩略图会漂到屏幕上方，把模型切换区域盖住；发送消息后整个列表只剩灰色背景，看不到任何气泡。

### 错误原因

`rvMessages` 的底部约束仍然连到 `chipGroup`，而 `chipGroup` 又锚定到输入栏上方。当附件预览隐藏或高度变化时，ConstraintLayout 解算失败，导致 `rvMessages` 被压到 0 高度并把 Chip 推到顶部。

### 解决方案

1. 引入 `action_container`（垂直 LinearLayout），容纳附件预览 `HorizontalScrollView` 与 `ChipGroup`
2. `rvMessages` 的底部约束改为 `@id/action_container`
3. 附件预览内部的 `LinearLayout` 仅负责横向列表，和输入栏解耦

**相关文件**：
- `app/src/main/res/layout/fragment_chat.xml`

**发生时间**：2025-12-02

---

## 发送图片后看不到任何气泡

### 问题描述

选择多张图片后点击“发送”，界面既没有自己的消息气泡，也没有 AI 回复，仿佛请求失败。

### 错误原因

1. 旧逻辑在图片选中时立刻发请求，未等待“发送”按钮，造成空文本被提交
2. RecyclerView 受上一节的约束问题影响，高度被压缩为 0，视觉上等于“没有消息”
3. `ChatMessageAdapter` 对附件处理只支持单张，未正确渲染多图

### 解决方案

1. `ChatFragment` 改用 `ActivityResultContracts.GetMultipleContents()`，把 URI 交给 `ChatViewModel` 缓存，点击“发送”以后再统一拼装到 `ChatRequest.images`
2. `ChatMessageAdapter` 在 `attachment_container` 中为每张图片生成 `ImageView`，`match_parent` + `fitCenter`
3. 修复布局约束（上一节）

**相关文件**：
- `app/src/main/java/com/example/dreamaichat_app/ui/chat/ChatFragment.java`
- `app/src/main/java/com/example/dreamaichat_app/ui/chat/ChatViewModel.java`
- `app/src/main/java/com/example/dreamaichat_app/ui/chat/adapter/ChatMessageAdapter.java`
- `app/src/main/res/layout/fragment_chat.xml`

**发生时间**：2025-12-02

---

## Toast 中文提示出现乱码

### 问题描述

点击抽屉菜单（模板中心 / 模型路由 / 对话图谱）或工具栏“新对话”时，Toast 内容显示为“宸插垱寤烘柊瀵硅瘽”等乱码。

### 错误原因

这些中文字符串直接硬编码在 `MainActivity` 中，源文件被保存为 ANSI 编码后再次转换成 UTF-8，导致字节序列损坏，最终在运行时渲染出乱码。

### 解决方案

1. 所有中文提示统一迁移到 `res/values/strings.xml`
2. 代码侧全部改为 `Toast.makeText(this, getString(R.string.xxx), Toast.LENGTH_SHORT).show()`

**相关文件**：
- `app/src/main/java/com/example/dreamaichat_app/ui/main/MainActivity.java`
- `app/src/main/res/values/strings.xml`

**发生时间**：2025-12-02

---

## 更新日志

- **2025-11-28**：
  - 添加 JWT 密钥长度不足错误的解决方案
  - 添加 XML 布局文件 BOM 字符错误的解决方案（包含批量修复命令）
- **2025-11-30**：
  - 添加 API 调用超时问题的解决方案
  - 添加 API Key 配置问题的解决方案
