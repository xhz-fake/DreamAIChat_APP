# 性能优化白皮书

> 写给训练营阶段的自己：第一次做客户端，一开始只想“先跑起来”。随着功能累积，卡顿、耗时、丢数据等问题暴露出来。下面是我如何用 vibe coding 边问边试，逐步把性能从“能用”拉到“顺滑可交付”的过程。

## 起点：问题清单

- 冷启动：首次进入聊天页时主线程有轻微掉帧（数据库和 Retrofit 初始化堆在一起）。
- 列表流畅度：长对话滑动偶尔卡顿。
- 数据安全：历史记录在登录/重登时曾被级联删除（REPLACE + 级联外键）。
- 网络耗时：接入云端后，偶尔因超时或 DNS 慢导致等待。



## 探索与取舍（vibe coding 纪实）

1) **冷启动分拆**  
   - 先问：“为什么进聊天页会顿一下？”  
   - AI 建议：延迟初始化重资源。我们把 Retrofit 和 Room 的实例创建改为“按需首次使用”，启动路径只保留最小 UI 。
2) **列表卡顿排查**  
   - 通过 Profiler 发现主线程偶发 IO。  
   - AI 提示：“尽量别在主线程查库”。现阶段为了演示保留了 allowMainThreadQueries，但我们在 TODO 里写下“迁 IO 线程 + 分页”。同时简化布局、删除“结构分析”芯片，减少测量。
3) **历史被清空的事故**  
   - 追溯到 `OnConflictStrategy.REPLACE` 触发外键级联。  
   - AI 方案：改成“先查再更新”，避免 REPLACE；移除 destructiveMigration，避免意外删库。落地后重登不再丢历史。
4) **网络超时与可观测性**  
   - 在云上测试时偶发 504。  
   - 调整 OkHttp 超时时间到 5~10s，Debug 保留 BODY 日志方便排查；Release 计划降级到 BASIC。  
   - 后端补了 `/api/diagnostics/providers`，用 curl 一键看 DNS/API key/连通性。



## 现状最佳实践（适用于当前 Demo）

- 布局：保持约束简单，输入区使用 56dp 的无文本 ImageButton；删除多余芯片，ChipGroup 居中排列。
- 列表：RecyclerView 复用 item_ai/user/system，避免多层嵌套；可开启 `setHasFixedSize(true)`。
- 网络：单例 Retrofit/OkHttp，Debug 开日志，Release 降级日志级别；BASE_URL 直指公网 IP。
- 数据：登录流程改为“存在即更新，不存在才插入”，避免级联删库；禁止 destructiveMigration。
- 线程：网络/库统一 `subscribeOn(IO) + observeOn(Main)`，UI 仅观察 LiveData。



## 后续路线（按优先级）

- P0：移除 `allowMainThreadQueries()`，DAO 全部切到 IO 线程。
- P0：为历史/对话列表加分页或分段加载，避免一次性加载长列表。
- P1：Release 打开 R8 `minifyEnabled` + `shrinkResources`，并跑一轮 assembleRelease 自测。
- P1：在关键链路埋点耗时（请求前后、Room 查询前后），便于进一步压栈。
- P2：接入崩溃/卡顿收集（Crashlytics/ACRA），为之后的优化积累数据。

