# DreamAIChat_APP 部署文档



## 1. 环境要求

### 1.1 开发环境

- **操作系统**: Windows 10/11, macOS, 或 Linux
- **JDK**: JDK 11 或更高版本
- **Android Studio**: Arctic Fox (2020.3.1) 或更高版本
- **Gradle**: 8.0 或更高版本（项目已包含 Gradle Wrapper）
- **Android SDK**: API 21 (Android 5.0) 或更高版本

### 1.2 硬件要求

- **内存**: 至少 8GB RAM（推荐 16GB）
- **存储空间**: 至少 10GB 可用空间
- **网络**: 需要稳定的网络连接以下载依赖



## 2. 项目结构

> 当前可用代码位于 `D:\ProgramFiles\CodeProjects\Android\projects\DreamAIChat\DreamAIChat_APP`。
```
DreamAIChat_APP/
├── app/                          # 应用模块
│   ├── src/
│   │   ├── main/
│   │   │   ├── java/            # Java 源代码
│   │   │   │   └── com/example/dreamaichat_app/
│   │   │   │       ├── data/    # 数据层
│   │   │   │       ├── domain/ # 领域层
│   │   │   │       ├── mvi/    # MVI 架构基础
│   │   │   │       ├── presentation/ # 表现层
│   │   │   │       └── ui/     # UI 层
│   │   │   ├── res/            # 资源文件
│   │   │   └── AndroidManifest.xml
│   │   └── test/               # 测试代码
│   └── build.gradle.kts        # 模块构建配置
├── gradle/                     # Gradle 配置
│   └── libs.versions.toml     # 依赖版本管理
├── build.gradle.kts            # 项目构建配置
├── settings.gradle.kts         # 项目设置
└── gradlew                     # Gradle Wrapper (Unix)
```



## 3. 安装步骤

### 3.1 克隆项目

```bash
# 如果项目在 Git 仓库中
git clone <repository-url>
cd DreamAIChat_APP
```

### 3.2 配置 Android Studio

1. **打开项目**
   - 启动 Android Studio
   - 选择 `File` → `Open`
   - 选择项目根目录

2. **同步 Gradle**
   - Android Studio 会自动检测项目并提示同步
   - 点击 `Sync Now` 或等待自动同步完成
   - 首次同步可能需要较长时间（下载依赖）

3. **配置 SDK**
   - 打开 `File` → `Project Structure` → `SDK Location`
   - 确保已安装 Android SDK Platform 21 或更高版本
   - 确保已安装 Android SDK Build-Tools

### 3.3 配置 API 地址

#### 3.3.1 什么是 API 地址？

API 地址（也叫 Base URL）是你的后端服务器地址。当应用需要获取数据或发送数据时，会向这个地址发送 HTTP 请求。

**简单理解**：

- 就像你家的地址一样，API 地址告诉应用"去哪里找数据"
- 例如：`https://api.example.com/` 就是服务器的地址
- 具体的接口（如登录、发送消息）会在这个地址后面添加路径

#### 3.3.2 配置步骤

**步骤 1：找到配置文件**

1. 在 Android Studio 左侧的 `Project` 面板中，找到以下路径：
   ```
   app → src → main → java → com → example → dreamaichat_app → data → remote → RetrofitClient.java
   ```
2. 双击打开 `RetrofitClient.java` 文件

**步骤 2：修改 BASE_URL**

在文件中找到这一行（大约在第 30 行左右）：
```java
private static final String BASE_URL = "https://api.example.com/";
```

将 `https://api.example.com/` 替换为你的实际 API 地址。

**重要提示**：

- ✅ 地址必须以 `http://` 或 `https://` 开头
- ✅ 地址末尾必须有斜杠 `/`
- ✅ 不要包含具体的接口路径（如 `/auth/login`），只写基础地址
- ❌ 错误示例：`api.example.com`（缺少协议）
- ❌ 错误示例：`https://api.example.com`（缺少末尾斜杠）
- ✅ 正确示例：`https://api.example.com/`

#### 3.3.3 不同场景的配置方法

**场景 1：使用本地开发服务器**

如果你在本地运行后端服务器（如使用 Spring Boot、Node.js 等）：

```java
// 如果使用 Android 模拟器，使用 10.0.2.2 代替 localhost
private static final String BASE_URL = "http://10.0.2.2:8081/";

// 如果使用真机调试，使用电脑的 IP 地址（在 cmd 中输入 ipconfig 查看）
private static final String BASE_URL = "http://192.168.1.100:8081/";
```

**如何查看电脑 IP 地址**：
- Windows：打开命令提示符（cmd），输入 `ipconfig`，找到 "IPv4 地址"
- Mac/Linux：打开终端，输入 `ifconfig`，找到 "inet" 地址

**场景 2：使用测试服务器**

如果你有测试环境的服务器地址：

```java
private static final String BASE_URL = "https://test-api.yourcompany.com/";
```

**场景 3：使用生产服务器**

正式发布时使用：

```java
private static final String BASE_URL = "https://api.yourcompany.com/";
```

**场景 4：暂时没有后端服务器（开发测试）**

如果你还没有后端服务器，可以：

1. **使用模拟数据**（推荐用于 UI 开发）
   - 暂时不修改 BASE_URL
   - 在 `LoginUseCase` 和 `SendMessageUseCase` 中返回模拟数据
   - 这样可以先完成界面开发

2. **使用公共测试 API**
   - 可以使用一些免费的测试 API 服务
   - 例如：`https://jsonplaceholder.typicode.com/`（仅用于测试，不是真实功能）

#### 3.3.4 配置示例

**完整配置示例**：

```java
public class RetrofitClient {
    // 开发环境 - 本地服务器
    private static final String BASE_URL = "http://10.0.2.2:8081/";
    
    // 或者测试环境
    // private static final String BASE_URL = "https://test-api.example.com/";
    
    // 或者生产环境
    // private static final String BASE_URL = "https://api.example.com/";
    
    // ... 其他代码
}
```

#### 3.3.5 如何验证配置是否正确？

**方法 1：查看日志**

1. 运行应用
2. 打开 Android Studio 底部的 `Logcat` 面板
3. 过滤标签：输入 `OkHttp` 或 `Retrofit`
4. 如果看到类似以下的日志，说明配置成功：
   ```
   D/OkHttp: --> POST https://api.example.com/auth/login
   D/OkHttp: Content-Type: application/json
   ```

**方法 2：测试登录功能**

1. 在应用中输入账号密码，点击登录
2. 查看 Logcat：
   - 如果看到网络请求日志，说明配置正确
   - 如果看到连接错误（如 "Failed to connect"），检查：
     - API 地址是否正确
     - 服务器是否运行
     - 网络是否连接

#### 3.3.6 常见问题解决方案

**问题 1：连接失败（Connection refused）**

**原因**：
- API 地址错误
- 服务器未运行
- 防火墙阻止连接

**解决方法**：
1. 检查 API 地址是否正确（包括协议、端口号）
2. 确认后端服务器正在运行
3. 检查网络连接

**问题 2：404 Not Found**

**原因**：
- API 路径错误
- 服务器上没有对应的接口

**解决方法**：
1. 检查 `ApiService.java` 中的接口路径是否正确
2. 与后端开发人员确认接口路径

**问题 3：SSL 证书错误（仅 HTTPS）**

**原因**：
- 使用了自签名证书
- 证书过期

**解决方法**（仅开发环境）：
- 暂时使用 HTTP 协议（不推荐生产环境）
- 或配置信任所有证书（仅用于开发测试）

#### 3.3.7 配置认证 Token（可选）

如果你的 API 需要认证 Token，需要在登录成功后保存 Token，然后在后续请求中使用。

**当前实现**：
- Token 在 `SendMessageUseCase` 中使用
- 登录成功后，Token 应该保存在 `SharedPreferences` 或数据库中
- 后续请求会自动带上 Token

**如何配置**（如果 Token 管理还未实现）：
1. 暂时可以在 `SendMessageUseCase` 中硬编码测试 Token
2. 后续会实现完整的 Token 管理机制

#### 3.3.8 下一步

配置完 API 地址后：
1. ✅ 保存文件（Ctrl+S 或 Cmd+S）
2. ✅ 同步项目（点击 Android Studio 顶部的 "Sync Now"）
3. ✅ 运行应用测试网络连接
4. ✅ 查看 Logcat 确认请求是否发送成功



## 4. Spring Boot 后端部署（DreamAIChat_backend）

Android 客户端已经不再依赖模拟数据，`DreamAIChat_backend` 提供真实的登录、对话、会话列表等接口。本节给出最小可运行版本的搭建步骤：

### 4.1 环境要求

- JDK 17（建议使用 Temurin/OpenJDK）
- Gradle 8+（项目自带 Wrapper，可直接运行 `./gradlew`）
- 可访问外网，用于请求 Doubao / DeepSeek API

### 4.2 在 IDEA 中启动后端

**步骤 1：创建运行配置**

1. 在 IDEA 中打开项目
2. 找到主类：`DreamAiChatBackendApplication.kt`
   - 路径：`DreamAIChat_backend/src/main/kotlin/com/dreamaichat/backend/DreamAiChatBackendApplication.kt`
3. 右键点击主类文件，选择 **"Run 'DreamAiChatBackendApplication'"**
   - 或者点击主类文件左侧的绿色三角形 ▶️

**步骤 2：配置运行参数**

1. 点击 IDEA 顶部工具栏的 **"Run"** → **"Edit Configurations..."**
2. 在左侧找到 **"DreamAiChatBackendApplication"** 配置
3. 在右侧配置面板中：

   **a. 设置 Active profiles（重要！）**
   
   - 找到 **"Active profiles"** 字段
   - 输入：`local`
   - 或者在 **"VM options"** 中添加：`-Dspring.profiles.active=local`
   
   **b. 设置环境变量**
   
   - 找到 **"Environment variables"**
   - 添加以下环境变量（如果使用系统环境变量，可以跳过此步）：
     ```
     DEEPSEEK_API_KEY=sk-你的密钥
     DOUBAO_API_KEY=你的豆包密钥
     ```

4. 点击 **"Apply"** → **"OK"** 保存配置

**步骤 3：启动后端**

1. 点击 IDEA 顶部工具栏的绿色运行按钮 ▶️
2. 或者按快捷键：`Shift + F10`
3. 查看控制台输出，应该看到：
   ```
   The following profiles are active: local
   Tomcat started on port 8081
   Started DreamAiChatBackendApplication in Xs
   ```

### 4.3 配置 API Key（系统环境变量方式）

**步骤 1：设置系统环境变量**

1. 按 `Win + R`，输入 `sysdm.cpl`，回车
2. 点击 **"高级"** → **"环境变量"**
3. 在 **"用户变量"** 区域点击 **"新建"**：
   - 变量名：`DEEPSEEK_API_KEY`
   - 变量值：你的 DeepSeek API Key（格式：`sk-xxxxx`）
4. 再次点击 **"新建"**：
   - 变量名：`DOUBAO_API_KEY`
   - 变量值：你的豆包 API Key
5. 点击 **"确定"** 保存

**步骤 2：在 IDEA 运行配置中添加环境变量**

1. 在 IDEA 运行配置的 **"Environment variables"** 中添加：
   ```
   DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
   DOUBAO_API_KEY=${DOUBAO_API_KEY}
   ```
2. 或者直接填写实际值（不推荐，因为会保存在配置文件中）

**步骤 3：重启后端服务**

1. 停止当前运行的后端（如果正在运行）
2. 在 IDEA 中重新启动后端
3. 后端会自动从系统环境变量读取 API Key

### 4.4 可用接口

| 方法 | 路径 | 说明 |
| --- | --- | --- |
| `POST /api/auth/register` | 创建账号（account + password） |
| `POST /api/auth/login` | 登录，返回 `token` 与 `userId` |
| `GET /api/chat/conversations` | 获取当前用户的会话列表（需要 `Authorization: Bearer <token>`） |
| `POST /api/chat/send` | 向所选模型发送消息，同时写入会话与消息表 |

所有接口都返回统一的 `ApiResponse<T>`，Android 侧已经适配。

### 4.5 与 Android 联调

1. 启动后端（默认端口 8081）
2. 确保模拟器可访问主机，Android 端 `RetrofitClient` 已设置 `http://10.0.2.2:8081/`
3. 在 App 内点击注册或登录，成功后会将 Token 写入 `SessionManager`
4. 聊天/历史页面即可实时调用后端

> 生产部署时可将 `DreamAIChat_backend` 打包为 Jar：`./gradlew bootJar`，上传至服务器后运行 `java -jar build/libs/DreamAIChat_backend-0.1.0.jar`，并通过 `application.yml` 或环境变量覆盖端口、数据库等配置。

### 4.6 大模型 API Key 申请与配置

#### 4.6.1 申请 API Key

**DeepSeek API Key**：
1. 访问 https://platform.deepseek.com/
2. 注册/登录账号
3. 进入 **"API Keys"** 页面
4. 点击 **"Create API Key"**，复制生成的 Key（格式：`sk-xxxxx`）

**豆包 API Key**：
1. 访问 https://www.volcengine.com/
2. 注册/登录账号
3. 搜索并开通 **"豆包"** 服务
4. 在 **"API 密钥管理"** 中创建密钥，复制生成的 Key

#### 4.6.2 配置系统环境变量

1. 按 `Win + R`，输入 `sysdm.cpl`，回车
2. 点击 **"高级"** → **"环境变量"**
3. 在 **"用户变量"** 区域点击 **"新建"**：
   - 变量名：`DEEPSEEK_API_KEY`，变量值：你的 DeepSeek API Key
   - 变量名：`DOUBAO_API_KEY`，变量值：你的豆包 API Key
4. 点击 **"确定"** 保存
5. **重要**：关闭所有已打开的终端/IDEA 窗口，重新打开 IDEA

#### 4.6.3 在 IDEA 中配置环境变量

1. 在 IDEA 运行配置的 **"Environment variables"** 中添加：
   ```
   DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
   DOUBAO_API_KEY=${DOUBAO_API_KEY}
   ```
2. 或者直接填写实际值（不推荐）

#### 4.6.4 验证配置

1. 在 IDEA 中启动后端
2. 在 Android 应用中发送测试消息
3. 如果收到真实的 AI 回复（不是演示模式），说明配置成功 ✅

**注意**：
- 模型名称必须与火山引擎控制台中的名称完全一致（豆包：`doubao-seed-1-6-vision-250815`）
- 如果修改模型名称，需要确保新模型在你的账户中可用
- 详细问题排查请参考 `vibe_coding实践文档/故障排查及解决文档.md`



## 5 配置数据库

### 5.1 什么是 Room 数据库？

**简单理解**：
- Room 是 Android 官方提供的数据库框架，基于 SQLite
- 就像 Excel 表格一样，用来存储应用的数据（用户信息、聊天记录等）
- 数据会保存在手机本地，即使关闭应用也不会丢失

**数据库结构**：
- **users 表**：存储用户信息（账号、密码、用户名等）
- **conversations 表**：存储会话信息（对话标题、使用的模型等）
- **messages 表**：存储消息内容（用户消息、AI回复等）

**数据关系**：
```
用户 (users)
  └── 会话 (conversations) - 一个用户可以有多个会话
        └── 消息 (messages) - 一个会话可以有多条消息
```

#### 5.1.1 Room 与 JDBC / Navicat 的直观对比

| 维度 | JDBC + Navicat | Room |
| --- | --- | --- |
| 思维模型 | 手写 SQL → 用连接串连到 MySQL | 仍然是 SQLite，但用注解描述表结构，Room 自动生成 SQL |
| 连接方式 | 直接连接远程数据库，Navicat 可实时查看 | App 内嵌 SQLite 文件，运行在手机沙箱；通过工具“窥视” |
| 常见开发痛点 | 需要手动管理连接、事务、游标 | Room 自动处理线程/事务，可用 DAO 接口声明 CRUD |
| 适用场景 | 服务端、PC 工具 | Android 客户端离线缓存、本地持久化 |

可以把 Room 想象成“内嵌版的 Navicat + ORM”：

1. **Entity（表结构）** ≈ Navicat 中建表
2. **DAO（接口）** ≈ 在 Navicat 里运行的 SQL 语句
3. **Database（AppDatabase）** ≈ Navicat 的连接配置

#### 5.1.2 Room 的“三件套”在项目中的对应文件

| 角色 | 职责 | 对应文件 |
| --- | --- | --- |
| `@Entity` | 描述表字段 | `data/entity/ConversationEntity.java`、`MessageEntity.java`、`UserEntity.java` |
| `@Dao` | 定义 CRUD 接口 | `data/dao/ConversationDao.java`、`MessageDao.java`、`UserDao.java` |
| `RoomDatabase` | 提供数据库访问入口 | `data/database/AppDatabase.java` |

调用顺序：

```
ChatViewModel → MessageRepository → MessageDao → Room → SQLite
```

所以你在 UI 层只需调用 Repository，Room 会负责把请求翻译成 SQL 并更新 SQLite 文件。

#### 5.1.3 和本项目的业务映射

- 登录后，`SessionManager` 保存 `userId`
- 聊天时：
  1. `ChatViewModel` 组装 `ConversationEntity` / `MessageEntity`
  2. 通过 `ConversationRepository`、`MessageRepository` 写入 Room
  3. 历史页面 (`HistoryFragment`) 通过 DAO 查询 `conversations`，RecyclerView 展示

理解这条链路后，再去看 `ConversationRepository.insertOrUpdateConversation()` 与 `ChatViewModel.persistConversationAndMessages()` 会更加直观。

### 5.2 数据库文件位置

**数据库文件位置**：
- 应用首次运行后，数据库文件会自动创建
- 位置：`/data/data/com.example.dreamaichat_app/databases/dreamai_chat.db`
- 这是应用私有目录，其他应用无法访问

**如何查看数据库文件**（开发调试）：
1. 使用 Android Studio 的 Device File Explorer
   - 点击 `View` → `Tool Windows` → `Device File Explorer`
   - 导航到 `/data/data/com.example.dreamaichat_app/databases/`
   - 可以看到 `dreamai_chat.db` 文件

2. 使用 ADB 命令（需要 root 权限）
   ```bash
   adb shell
   run-as com.example.dreamaichat_app
   cd databases
   ls
   ```

### 5.3 数据库配置说明

**步骤 1：检查数据库文件是否已创建**

数据库文件在以下位置：
```
app/src/main/java/com/example/dreamaichat_app/data/database/AppDatabase.java
```

**步骤 2：了解数据库配置**

打开 `AppDatabase.java`，你会看到以下配置：

```java
@Database(
    entities = {
        UserEntity.class,        // 用户表
        ConversationEntity.class, // 会话表
        MessageEntity.class      // 消息表
    },
    version = 1,  // 数据库版本号
    exportSchema = false
)
```

**重要配置说明**：

1. **数据库名称**：
   
   ```java
   private static final String DATABASE_NAME = "dreamai_chat.db";
   ```
   - 这是数据库文件名
   - 可以修改为你想要的名称（如 `my_chat.db`）
   - 修改后，旧数据库会被删除（开发环境）
   
2. **数据库版本**：
   ```java
   version = 1
   ```
   - 每次修改表结构（添加字段、删除表等）时，需要递增版本号
   - 例如：第一次修改后改为 `version = 2`
   - 生产环境需要实现 `Migration` 类来迁移数据

3. **开发环境配置**：
   ```java
   .fallbackToDestructiveMigration()  // 版本升级时删除旧数据
   .allowMainThreadQueries()          // 允许在主线程查询
   ```
   - **注意**：这些配置仅用于开发环境
   - 生产环境需要移除 `allowMainThreadQueries()`，并使用后台线程

### 5.4 数据库初始化流程

**首次运行应用时**：

1. **应用启动** → 调用 `AppDatabase.getInstance(context)`
2. **Room 框架检查** → 数据库文件是否存在？
   - 如果不存在 → 创建数据库文件
   - 如果存在 → 检查版本号是否匹配
3. **创建表结构** → 根据 `@Entity` 注解自动创建表
4. **数据库就绪** → 可以开始使用

**数据库表结构**：

**users 表**：
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | Long | 用户ID（主键，自动生成）|
| account | String | 用户账号（手机号或邮箱）|
| password | String | 密码（加密后）|
| username | String | 用户名 |
| avatarUrl | String | 头像URL |
| memberType | String | 会员类型（free/premium）|
| token | String | 登录Token |
| tokenExpireTime | Long | Token过期时间 |
| createdAt | Long | 创建时间 |
| updatedAt | Long | 更新时间 |

**conversations 表**：
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | Long | 会话ID（主键，自动生成）|
| userId | Long | 用户ID（外键）|
| title | String | 会话标题 |
| model | String | 使用的AI模型 |
| messageCount | Integer | 消息总数 |
| isFavorite | Boolean | 是否收藏 |
| lastMessagePreview | String | 最后消息预览 |
| lastMessageTime | Long | 最后消息时间 |
| createdAt | Long | 创建时间 |
| updatedAt | Long | 更新时间 |

**messages 表**：
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | Long | 消息ID（主键，自动生成）|
| conversationId | Long | 会话ID（外键）|
| role | String | 消息类型（user/assistant/system）|
| content | String | 消息内容 |
| status | String | 消息状态（sending/success/failed）|
| errorMessage | String | 错误信息 |
| createdAt | Long | 创建时间 |
| updatedAt | Long | 更新时间 |

### 5.5 如何使用数据库

**在代码中使用数据库**：

1. **获取 Repository 实例**：
   ```java
   UserRepository userRepository = new UserRepository(context);
   ```

2. **插入数据**：
   ```java
   UserEntity user = new UserEntity("user@example.com", "password", "用户名");
   userRepository.insertOrUpdateUser(user)
       .subscribe(
           () -> Log.d("Database", "用户保存成功"),
           error -> Log.e("Database", "保存失败", error)
       );
   ```

3. **查询数据**：
   ```java
   userRepository.getUserByAccount("user@example.com")
       .subscribe(
           user -> Log.d("Database", "找到用户: " + user.username),
           error -> Log.e("Database", "查询失败", error)
       );
   ```

### 5.6 数据库迁移（生产环境）

**什么时候需要迁移**：

- 修改了表结构（添加字段、删除字段、修改字段类型）
- 需要保留旧数据

**迁移步骤**：

1. **增加数据库版本号**：
   ```java
   @Database(..., version = 2)  // 从 1 改为 2
   ```

2. **创建 Migration 类**：
   ```java
   static final Migration MIGRATION_1_2 = new Migration(1, 2) {
       @Override
       public void migrate(SupportSQLiteDatabase database) {
           // 添加新字段
           database.execSQL("ALTER TABLE users ADD COLUMN nickname TEXT");
       }
   };
   ```

3. **应用 Migration**：
   ```java
   .addMigrations(MIGRATION_1_2)
   ```

### 5.7 验证数据库是否正常工作

**方法 1：查看日志**

运行应用后，在 Logcat 中搜索 "Database" 或 "Room"：
- 如果看到 "数据库创建成功" 或类似日志，说明数据库正常
- 如果看到错误信息，检查配置是否正确

**方法 2：测试数据操作**

在代码中添加测试代码：
```java
// 测试插入用户
UserRepository repository = new UserRepository(context);
UserEntity testUser = new UserEntity("test@example.com", "123456", "测试用户");
repository.insertOrUpdateUser(testUser)
    .subscribe(
        () -> Log.d("Test", "✅ 数据库测试成功"),
        error -> Log.e("Test", "❌ 数据库测试失败", error)
    );
```

**方法 3：使用数据库查看工具**

1. 导出数据库文件到电脑
2. 使用 SQLite 查看工具（如 DB Browser for SQLite）打开
3. 查看表结构和数据

### 5.8 常见问题

**问题 1：数据库文件未创建**

**原因**：
- 应用未运行
- 数据库初始化失败

**解决方法**：
1. 确保应用已运行至少一次
2. 检查 `AppDatabase.java` 中的配置是否正确
3. 查看 Logcat 中的错误信息

**问题 2：Room 编译错误**

**原因**：
- 缺少 `kapt` 插件
- `room-compiler` 依赖未正确配置

**解决方法**：
1. 检查 `app/build.gradle.kts` 中是否包含：
   ```kotlin
   plugins {
       alias(libs.plugins.kotlin.kapt)
   }
   dependencies {
       kapt(libs.room.compiler)
   }
   ```
2. 同步 Gradle：`File` → `Sync Project with Gradle Files`
3. 清理项目：`Build` → `Clean Project`

**问题 3：数据丢失**

**原因**：
- 使用了 `fallbackToDestructiveMigration()`
- 数据库版本号改变

**解决方法**：
- 开发环境：这是正常行为，数据会被清空
- 生产环境：实现 `Migration` 类来保留数据

**问题 4：查询返回空数据**

**原因**：
- 数据未插入
- 查询条件错误

**解决方法**：
1. 检查数据是否已插入（使用数据库查看工具）
2. 检查查询条件是否正确
3. 查看 Logcat 中的查询日志

### 5.9 数据可视化 & 调试工具（Navicat 思路平移）

即便数据库在手机沙箱里，仍然可以像 Navicat 一样“看表、跑 SQL”：

1. **Android Studio Database Inspector（实时查看）**
   - 运行 App → `View` → `Tool Windows` → `App Inspection`
   - 选择正在运行的进程 → 展开 `Databases` → `dreamai_chat.db`
   - 可以直接浏览表、双击行、甚至执行 `SELECT * FROM messages ORDER BY createdAt DESC`
   - 支持热更新：当你在 App 内发送一条消息，Inspector 会立刻刷新

2. **导出 SQLite 文件后用桌面工具查看**
   - `adb shell run-as com.example.dreamaichat_app cp /data/data/com.example.dreamaichat_app/databases/dreamai_chat.db /sdcard/Download/dreamai_chat.db`
   - `adb pull /sdcard/Download/dreamai_chat.db .`
   - 使用 DB Browser for SQLite / SQLiteStudio / TablePlus 打开，就像用 Navicat 查看 MySQL

3. **第三方插件**
   - Android Studio Marketplace 中搜索 “SampleSQLiteBrowser”，可以获得更接近 Navicat 的界面

> 小贴士：Room 也可以开启 `setJournalMode(TRUNCATE)`、`setQueryCallback` 来把 SQL 打印到 Logcat，方便对照 JDBC 时代的 SQL。

### 5.9 数据库最佳实践

1. **使用后台线程**：
   - 生产环境必须在后台线程执行数据库操作
   - 使用 RxJava 的 `subscribeOn(Schedulers.io())`

2. **及时关闭连接**：
   - 应用退出时调用 `AppDatabase.closeDatabase()`
   - 避免内存泄漏

3. **数据备份**：
   - 定期备份重要数据
   - 使用 Room 的导出功能

4. **性能优化**：
   - 使用索引加速查询（已在 Entity 中定义）
   - 避免在主线程执行耗时操作
   - 使用批量插入提高效率



### 5.10 下一步

配置完数据库后：
1. ✅ 运行应用，确认数据库文件已创建
2. ✅ 测试数据插入和查询功能
3. ✅ 查看 Logcat 确认没有错误
4. ✅ 继续开发其他功能



## 6. 构建项目

### 6.1 使用 Android Studio

1. **选择构建变体**
   - 点击 `Build` → `Select Build Variant`
   - 选择 `debug` 或 `release`

2. **构建 APK**
   - 点击 `Build` → `Build Bundle(s) / APK(s)` → `Build APK(s)`
   - 构建完成后，APK 位于 `app/build/outputs/apk/`

3. **运行应用**
   - 连接 Android 设备或启动模拟器
   - 点击 `Run` → `Run 'app'` 或按 `Shift + F10`

### 6.2 使用命令行

#### Windows

```powershell
# 清理构建
.\gradlew clean

# 构建 Debug APK
.\gradlew assembleDebug

# 构建 Release APK
.\gradlew assembleRelease

# 安装到设备
.\gradlew installDebug
```

#### macOS/Linux

```bash
# 清理构建
./gradlew clean

# 构建 Debug APK
./gradlew assembleDebug

# 构建 Release APK
./gradlew assembleRelease

# 安装到设备
./gradlew installDebug
```



## 7. 运行应用

### 7.1 在模拟器上运行

1. **创建模拟器**
   - 打开 `Tools` → `Device Manager`
   - 点击 `Create Device`
   - 选择设备型号和系统镜像（API 21+）
   - 完成创建

2. **运行应用**
   - 选择创建的模拟器
   - 点击 `Run` 按钮

### 7.2 在真机上运行

1. **启用开发者选项**
   - 打开设备 `设置` → `关于手机`
   - 连续点击 `版本号` 7次
   - 返回设置，找到 `开发者选项`

2. **启用 USB 调试**
   - 在 `开发者选项` 中启用 `USB 调试`
   - 连接设备到电脑

3. **运行应用**
   - Android Studio 会自动检测设备
   - 选择设备并点击 `Run`



## 8. 常见问题

### 8.1 Gradle 同步失败

**问题**: Gradle 同步时出现错误

**解决方案**:
1. 检查网络连接
2. 检查 `gradle/libs.versions.toml` 中的版本号是否正确
3. 清理项目: `File` → `Invalidate Caches / Restart`
4. 删除 `.gradle` 文件夹后重新同步

### 8.2 依赖下载失败

**问题**: 依赖下载超时或失败

**解决方案**:
1. 配置国内镜像源（如阿里云）
2. 在 `build.gradle.kts` 中添加镜像配置:
   ```kotlin
   repositories {
       maven { url = uri("https://maven.aliyun.com/repository/public") }
       google()
       mavenCentral()
   }
   ```

### 8.3 Room 编译错误

**问题**: Room 注解处理器报错

**解决方案**:
1. 确保已添加 `kotlin-kapt` 插件
2. 确保 `room-compiler` 依赖已正确配置
3. 清理并重新构建项目

### 8.4 ViewBinding 不工作

**问题**: ViewBinding 生成的类找不到

**解决方案**:
1. 确保 `buildFeatures { viewBinding = true }` 已配置
2. 清理并重新构建项目
3. 检查布局文件名称是否正确（不能以下划线开头）

### 8.5 网络请求失败

**问题**: API 请求返回错误

**解决方案**:
1. 检查 `RetrofitClient` 中的 `BASE_URL` 是否正确
2. 检查网络权限是否已添加（AndroidManifest.xml）
3. 检查 API 服务器是否可访问
4. 查看 Logcat 中的错误信息



## 9. 图片资源配置

> 本章把“图标在哪里”“如何一键替换”“替换后要检查什么”全部列清楚，新手也能按表完成所有替换。

### 9.1 启动 / 桌面图标（mipmap + Adaptive）

- 位置：`app/src/main/res/mipmap-*`
- 必须保留文件名：`ic_launcher.png`、`ic_launcher_round.png`

| 目录 | 像素 | 说明 |
| --- | --- | --- |
| `mipmap-mdpi/` | 48×48 | 低密度 |
| `mipmap-hdpi/` | 72×72 | 高密度 |
| `mipmap-xhdpi/` | 96×96 | 超高密度 |
| `mipmap-xxhdpi/` | 144×144 | 超超高密度 |
| `mipmap-xxxhdpi/` | 192×192 | 超超超高密度 |
| `mipmap-anydpi-v26/` | XML | Android 8.0+ 自适应容器 |

自适应图标由两个图层组成：

- `app/src/main/res/drawable/ic_launcher_background.xml`（背景色）
- `app/src/main/res/drawable-v24/ic_launcher_foreground.xml`（LOGO）

> `AndroidManifest` 默认引用 `@mipmap/ic_launcher`，替换完素材重新编译即可生效。

### 9.2 聊天界面图标 & 背景对照表

| 资源 | 目录 | 使用场景 | 引用文件 | 替换建议 |
| --- | --- | --- | --- | --- |
| `ic_attach.xml` | `drawable/` | 输入框“图片”按钮 | `fragment_chat.xml` | 24dp SVG，保持描边宽度 |
| `ic_copy_16.xml` | `drawable/` | AI 气泡复制按钮 | `item_message_ai.xml` | 16–20dp，避免遮挡文本 |
| `ic_chevron_down.xml` | `drawable/` | 模型切换箭头 | `fragment_chat.xml`（模型 header） | 仅改色可直接调 `fillColor` |
| `ic_ai_avatar_placeholder.xml` | `drawable/` | AI 头像占位 | `item_message_ai.xml` | 可替换为品牌形象 |
| `ic_pin_indicator.xml` | `drawable/` | 历史置顶提示 | `item_conversation.xml` | 16dp 以内 |
| `ic_close_24.xml` | `drawable/` | 附件缩略图删除 | `item_attachment_preview.xml` | 可换圆形/叉号 |
| `ic_menu_24.xml` | `drawable/` | Toolbar 抽屉图标 | `activity_main.xml` | 换 LOGO 时别忘了 contentDescription |
| `bg_model_tag.xml` | `drawable/` (Shape) | 模型标签背景 | `fragment_chat.xml`、`item_conversation.xml` | 直接改颜色/圆角 |
| `bg_system_message.xml` | `drawable/` (Shape) | “正在生成”提示 & 附件卡片 | `fragment_chat.xml` | 可改渐变或阴影 |
| `divider_attachment_preview.xml` | `drawable/` (Shape) | 附件分隔线 | `fragment_chat.xml` | 透明即可隐藏 |

按表替换同名文件即可，布局引用无需改动。

### 9.3 图标替换实操流程

1. **确认类型**：桌面图标（mipmap）还是界面图标（drawable）
2. **准备素材**：
   - 启动图标：1024×1024 PNG/SVG，透明背景
   - 界面图标：优先 SVG，不能矢量化时用 48×48 PNG 并在 AS 中转 Vector
3. **导入方式**：
   - Android Studio → `New` → `Image Asset / Vector Asset`，输出到目标文件名
   - 或者手动把 SVG/XML 覆盖到 `drawable/`
4. **构建验证**：
   - `Build` → `Rebuild Project`
   - 安装到手机，检查：桌面图标、聊天页、历史页、导航抽屉是否全部显示为新样式

### 9.4 其他图片资源及尺寸

- `drawable-mdpi/`、`drawable-hdpi/` ...：需要不同密度 PNG 时，把同名文件放到对应目录即可
- 常用尺寸参考：

| 用途 | 推荐尺寸 | 目录 |
| --- | --- | --- |
| 启动页/空态插画 | 1080×1920 PNG/WebP | `drawable/` |
| 用户/AI 头像 | 64×64 PNG | `drawable/` |
| 聊天气泡背景 | Shape XML | `drawable/` |

### 9.5 更换图标 Checklist

1. 记录要替换的资源名称（参考 9.2）
2. 备份当前 `drawable/`、`mipmap/`（或直接依赖 Git）
3. 批量导入新 SVG/PNG，保持文件名一致
4. 需要调整颜色时优先使用 `android:tint` / `android:fillColor`
5. `Build` → `Rebuild Project` → 真机/模拟器逐屏自检
6. 把更新后的 `res/` 目录提交到 Git

### 9.6 常见问题 FAQ

| 问题 | 可能原因 | 解决方案 |
| --- | --- | --- |
| 替换后图标没变化 | 覆盖了 `drawable/`，但布局引用 `mipmap/` | 检查布局引用，必要时把资源放到正确目录 |
| SVG 导入失败 | 文件包含 `clipPath` / `mask` | 用 Illustrator 重新导出“简单路径”版或转成 PNG |
| 颜色不对 | 布局层设置了 `android:tint` | 同步修改布局里的 `tint`，或去掉 `tint` 直接在矢量里设色 |
| APK 体积暴增 | 导入了多套大图 | 改用 SVG/WebP，删除未使用的密度变体 |


## 10. XML 文件问题排查

### 10.1 "Valid XML document must have a root tag" 错误

如果遇到此错误，请检查以下内容：

1. **检查 XML 文件是否完整**
   - 确保每个 XML 文件都有正确的根标签
   - 确保 XML 文件没有被截断

2. **常见问题文件**
   - `app/src/main/res/xml/data_extraction_rules.xml`
   - `app/src/main/res/xml/backup_rules.xml`
   - `app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml`
   - `app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml`

3. **解决方法**
   - 在 Android Studio 中，选择 `File` → `Invalidate Caches / Restart`
   - 清理项目: `Build` → `Clean Project`
   - 重新构建: `Build` → `Rebuild Project`

4. **验证 XML 文件**
   - 确保所有 XML 文件都以 `<?xml version="1.0" encoding="utf-8"?>` 开头
   - 确保有且仅有一个根元素
   - 确保所有标签都正确闭合



## 11. 配置说明

### 11.1 网络权限

确保 `AndroidManifest.xml` 中包含网络权限:

```xml
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
```

### 11.2 应用配置

**应用 ID**: `com.example.dreamaichat_app`

如需修改，编辑 `app/build.gradle.kts`:
```kotlin
defaultConfig {
    applicationId = "com.yourcompany.dreamaichat_app"
    // ...
}
```

**版本信息**:
- Version Code: 1
- Version Name: "1.0"

### 11.3 签名配置（Release 构建）

1. **生成密钥库**
   ```bash
   keytool -genkey -v -keystore dreamai-release.jks -keyalg RSA -keysize 2048 -validity 10000 -alias dreamai
   ```

2. **配置签名**
   在 `app/build.gradle.kts` 中添加:
   ```kotlin
   android {
       signingConfigs {
           create("release") {
               storeFile = file("path/to/keystore.jks")
               storePassword = "your-store-password"
               keyAlias = "dreamai"
               keyPassword = "your-key-password"
           }
       }
       buildTypes {
           release {
               signingConfig = signingConfigs.getByName("release")
               // ...
           }
       }
   }
   ```



## 12. 开发建议

### 12.1 代码规范

- 遵循 Java 编码规范
- 使用有意义的变量和方法名
- 添加必要的注释
- 保持代码简洁

### 12.2 调试技巧

1. **使用 Logcat**
   - 查看应用日志
   - 过滤特定标签
   - 搜索错误信息

2. **使用断点**
   - 在关键代码处设置断点
   - 使用调试模式运行应用
   - 检查变量值

3. **使用 Android Profiler**
   - 监控 CPU 使用
   - 监控内存使用
   - 监控网络请求

### 12.3 测试

1. **单元测试**
   - 测试 UseCase 和 Repository
   - 使用 JUnit 和 Mockito

2. **UI 测试**
   - 使用 Espresso 进行 UI 测试
   - 测试关键用户流程



## 13. 发布准备

### 13.1 代码混淆

在 `app/proguard-rules.pro` 中添加混淆规则:

```proguard
# Retrofit
-keepattributes Signature, InnerClasses
-keepattributes RuntimeVisibleAnnotations, RuntimeVisibleParameterAnnotations
-keepclassmembers,allowshrinking,allowobfuscation interface * {
    @retrofit2.http.* <methods>;
}

# Room
-keep class * extends androidx.room.RoomDatabase
-keep @androidx.room.Entity class *
```

### 13.2 资源优化

1. **移除未使用的资源**
   
   ```bash
   ./gradlew clean
   ```
   
2. **压缩图片资源**
   - 使用 WebP 格式
   - 使用适当的图片尺寸

### 13.3 性能优化

1. **启用 ProGuard**
   ```kotlin
   buildTypes {
       release {
           isMinifyEnabled = true
           proguardFiles(getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro")
       }
   }
   ```

2. **启用资源压缩**
   ```kotlin
   buildTypes {
       release {
           isShrinkResources = true
       }
   }
   ```



## 14. 后续步骤

1. **实现剩余功能**
   - 完善聊天界面功能
   - 实现历史记录管理
   - 实现个人中心功能
   - 实现特色功能（模板、路由、图谱）

2. **集成第三方服务**
   - 微信登录 SDK
   - 苹果登录 SDK
   - 推送服务

3. **优化用户体验**
   - 添加加载动画
   - 优化错误提示
   - 添加离线支持

4. **测试和优化**
   - 进行全面的功能测试
   - 性能优化
   - 内存泄漏检查
